name: CI/CD Pipeline
on:
  push:
    branches:
      - main 
jobs:
  build-publish-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Need write permission to push manifest changes
      packages: write  # Needed to push to GHCR registry

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install yq for modifying the YAML manifest
      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # Use the Git SHA as the image tag for better versioning
          tags: ghcr.io/${{ github.repository_owner }}/personal-site:${{ github.sha }},ghcr.io/${{ github.repository_owner }}/personal-site:latest
          platforms: linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args:
            GIT_SHA=${{ github.sha }}

      - name: Update Kubernetes manifest with new image tag
        # env:
        #   # GITHUB_TOKEN is automatically provided by GitHub Actions
        #   # GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Not needed explicitly if token is used correctly by yq/git
        run: |
          # Use the Git SHA as the image tag for the deployment
          NEW_IMAGE_TAG="ghcr.io/${{ github.repository_owner }}/personal-site:${{ github.sha }}"

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git pull origin main # Pull latest changes to avoid merge conflicts

          # Use yq to update the image tag in your deployment.yaml
          # Ensure the path 'k8s/deployment.yaml' is correct relative to the repository root
          # The path 'spec.template.spec.containers[0].image' points to the image field in the first container spec
          yq e '.spec.template.spec.containers[0].image = "'"$NEW_IMAGE_TAG"'"' -i k8s/deployment.yaml

          # Commit and push the updated manifest
          # Add the deployment.yaml file to staging
          git add k8s/deployment.yaml

          # Check if there are any changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit in k8s/deployment.yaml."
          else
            git commit -m "CI: Update personal-site image to ${{ github.sha }}"
            git push origin main
          fi

      - name: Wait for Argo CD sync and application rollout (Estimation)
        run: |
          echo "Waiting for Argo CD to sync and application to roll out..."
          sleep 90 # Adjust this based on your observed sync and rollout time
      - name: Verify deployed site version (Debugging grep)
        env:
          SITE_DOMAIN: nkdem.net
          EXPECTED_SHA: ${{ github.sha }}
        run: |
          echo "Checking if the deployed site at https://${SITE_DOMAIN} shows commit ${EXPECTED_SHA}"

          # Use curl to fetch the site content
          SITE_CONTENT=$(curl -s -L --fail --retry 5 --retry-delay 10 -k https://${SITE_DOMAIN})

          # Print the fetched content to the logs for debugging
          echo "--------------- Fetched site content ---------------"
          echo "${SITE_CONTENT}"
          echo "--------------------------------------------------"

          # Now grep the fetched content for the expected SHA
          if echo "${SITE_CONTENT}" | grep "${EXPECTED_SHA}"; then
            echo "Successfully verified deployed site version matches commit ${EXPECTED_SHA}"
            exit 0 # Explicitly exit with 0 on success
          else
            echo "Error: Deployed site version does NOT match commit ${EXPECTED_SHA}"
            exit 1 # Explicitly exit with 1 on failure
          fi
